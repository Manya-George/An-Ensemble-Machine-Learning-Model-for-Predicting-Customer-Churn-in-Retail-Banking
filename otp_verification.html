
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Verification</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="otp_styles.css">
</head>
<body>
    <div class="container">
        <h1>OTP VERIFICATION</h1>
        
        <p class="email-info">An OTP has been sent to your email address u*****.com</p>
        
        <p class="instruction">Kindly enter the otp below:</p>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="successMessage" class="success-message" style="display: none;"></div>
        
        <div class="otp-container">
            <input type="text" class="otp-input" maxlength="1" id="otp1">
            <input type="text" class="otp-input" maxlength="1" id="otp2">
            <input type="text" class="otp-input" maxlength="1" id="otp3">
            <input type="text" class="otp-input" maxlength="1" id="otp4">
            <input type="text" class="otp-input" maxlength="1" id="otp5">
            <input type="text" class="otp-input" maxlength="1" id="otp6">
        </div>
        
        <div class="footer-info">
            <p class="timer" id="timer">The OTP will remain valid for 1:00</p>
            <a href="#" class="resend-link" id="resendLink">Resend OTP</a>
        </div>
        
        <button class="verify-btn" id="verifyBtn">
            <span id="btnText">Verify OTP</span>
            <span id="btnLoader" style="display: none;">Verifying...</span>
        </button>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        const otpInputs = document.querySelectorAll('.otp-input');
        let timeLeft = 60;
        let countdownInterval;
        let otpExpired = false;
        
        // Display masked email
        const maskedEmail = sessionStorage.getItem('masked_email');
        if (maskedEmail) {
            document.getElementById('emailInfo').textContent = 
                `An OTP has been sent to your email address ${maskedEmail}`;
        }
        
        // Show toast notification
        function showToast(message) {
            // Remove existing toast if any
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <span class="toast-icon">âœ“</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        
        // Show initial toast on page load
        window.addEventListener('load', () => {
            showToast('OTP successfully sent, kindly check your email.');
        });
        
        // Auto-focus next input
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
            
            input.addEventListener('keypress', (e) => {
                if (!/[0-9]/.test(e.key)) {
                    e.preventDefault();
                }
            });
        });
        
        // Format time as MM:SS
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Timer countdown
        function startTimer() {
            const timerElement = document.getElementById('timer');
            otpExpired = false;
            
            // Clear any existing interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                timeLeft--;
                timerElement.textContent = `The OTP will remain valid for ${formatTime(timeLeft)}`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    timerElement.textContent = 'OTP has expired';
                    timerElement.style.color = '#f44336';
                    otpExpired = true;
                    
                    // Mark OTP as expired in backend (optional - backend already checks expiry)
                    markOtpAsExpired();
                }
            }, 1000);
        }
        
        // Mark OTP as expired
        async function markOtpAsExpired() {
            try {
                await fetch(`${API_URL}/mark-otp-expired`, {
                    method: 'POST',
                    credentials: 'include'
                });
                console.log('OTP marked as expired in database');
            } catch (error) {
                console.error('Error marking OTP as expired:', error);
            }
        }
        
        startTimer();
        
        // Verify OTP
        document.getElementById('verifyBtn').addEventListener('click', async () => {
            let otp = '';
            otpInputs.forEach(input => {
                otp += input.value;
            });
            
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            const verifyBtn = document.getElementById('verifyBtn');
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            
            if (otp.length !== 6) {
                errorMsg.textContent = 'Please enter complete 6-digit OTP';
                errorMsg.style.display = 'block';
                successMsg.style.display = 'none';
                return;
            }
            
            if (otpExpired) {
                errorMsg.textContent = 'OTP has expired. Please request a new one.';
                errorMsg.style.display = 'block';
                successMsg.style.display = 'none';
                return;
            }
            
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            // Show loader
            verifyBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';
            
            try {
                const response = await fetch(`${API_URL}/verify-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ otp })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successMsg.textContent = 'OTP verified successfully! Redirecting...';
                    successMsg.style.display = 'block';
                    
                    // Clear session storage
                    sessionStorage.removeItem('masked_email');
                    
                    // Redirect based on role
                    setTimeout(() => {
                        if (data.role === 'IT admin') {
                            window.location.href = 'IT_admin_dashboard.html';
                        } else if (data.role === 'manager') {
                            window.location.href = 'manager_dashboard.html';
                        } else {
                            window.location.href = 'user_dashboard.html';
                        }
                    }, 1500);
                } else {
                    errorMsg.textContent = data.message;
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('Verification error:', error);
                errorMsg.textContent = 'Connection error. Please try again.';
                errorMsg.style.display = 'block';
            } finally {
                verifyBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        });
        
        // Resend OTP
        document.getElementById('resendLink').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            const resendLink = document.getElementById('resendLink');
            
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            resendLink.textContent = 'Sending...';
            
            try {
                const response = await fetch(`${API_URL}/resend-otp`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show toast notification
                    showToast('OTP successfully sent, kindly check your email.');
                    
                    // Clear OTP inputs
                    otpInputs.forEach(input => input.value = '');
                    otpInputs[0].focus();
                    
                    // Reset timer
                    clearInterval(countdownInterval);
                    timeLeft = 60;
                    const timerElement = document.getElementById('timer');
                    timerElement.style.color = '#666';
                    timerElement.textContent = 'The OTP will remain valid for 1:00';
                    otpExpired = false;
                    startTimer();
                } else {
                    errorMsg.textContent = data.message;
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('Resend error:', error);
                errorMsg.textContent = 'Failed to resend OTP. Please try again.';
                errorMsg.style.display = 'block';
            } finally {
                resendLink.textContent = 'Resend OTP';
            }
        });
    </script>
</body>
</html>